<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ORBITAL DEFENSE COMMAND</title>

  <!-- Allow inline script/style via META CSP (helps if no CSP header is set).
       If your Cloudflare Pages project sets a CSP header, that header wins.
       In that case, either loosen the header or move JS to an external file allowed by your CSP. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #fff; overflow: hidden; height: 100vh; display: flex; flex-direction: column;
    }
    #header { background: rgba(0,0,0,.8); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 2px solid #00ffcc; box-shadow: 0 2px 20px rgba(0,255,204,.3); }
    .stat-display { display: flex; gap: 30px; font-size: 18px; font-weight: bold; }
    .stat-item { color: #00ffcc; text-shadow: 0 0 10px rgba(0,255,204,.5); }
    .stat-label { color: #8899aa; margin-right: 5px; }
    #gameContainer { flex: 1; display: flex; position: relative; }
    #canvas { background: radial-gradient(ellipse at center, #1a2332 0%, #0a0e1a 100%); border: 2px solid #00ffcc;
      box-shadow: 0 0 50px rgba(0,255,204,.2); margin: 20px; }
    #sidePanel { width: 350px; background: rgba(0,0,0,.9); padding: 20px; overflow-y: auto; border-left: 2px solid #00ffcc; }
    .panel-section { margin-bottom: 25px; padding: 15px; background: rgba(26,31,58,.5); border-radius: 8px; border: 1px solid rgba(0,255,204,.3); }
    .section-title { font-size: 20px; color: #00ffcc; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px;
      text-shadow: 0 0 15px rgba(0,255,204,.7); }
    .unit-card { background: rgba(0,255,204,.1); border: 1px solid #00ffcc; padding: 12px; margin-bottom: 12px; border-radius: 5px;
      cursor: pointer; transition: .3s; position: relative; overflow: hidden; }
    .unit-card::before { content: ''; position: absolute; inset: -2px; background: linear-gradient(45deg,#00ffcc,#0099ff,#00ffcc);
      border-radius: 5px; opacity: 0; z-index: -1; transition: opacity .3s; }
    .unit-card:hover::before { opacity: .5; }
    .unit-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,255,204,.4); }
    .unit-card.selected { background: rgba(0,255,204,.3); border-color: #fff; }
    .unit-card.disabled { opacity: .5; cursor: not-allowed; }
    .unit-name { font-size: 16px; font-weight: bold; color:#fff; margin-bottom: 5px; }
    .unit-stats { font-size: 12px; color: #8899aa; line-height: 1.5; }
    .unit-cost { font-size: 14px; color: #ffaa00; font-weight: bold; margin-top: 5px; }
    .upgrade-button { background: linear-gradient(135deg,#00ffcc,#0099ff); border: none; color: #000; padding: 8px 16px; border-radius: 4px;
      cursor: pointer; font-weight: bold; margin-top: 8px; transition: .3s; text-transform: uppercase; letter-spacing: 1px; }
    .upgrade-button:hover:not(:disabled){ transform: scale(1.05); box-shadow: 0 5px 20px rgba(0,255,204,.6); }
    .upgrade-button:disabled { opacity: .5; cursor: not-allowed; background: #555; }
    #menuOverlay{ position: fixed; inset: 0; background: rgba(0,0,0,.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .menu-container{ background: linear-gradient(135deg,#1a2332 0%,#0a0e1a 100%); border:2px solid #00ffcc; border-radius:15px; padding:40px;
      text-align:center; box-shadow:0 0 50px rgba(0,255,204,.5); max-width:500px; }
    .game-title{ font-size:48px; color:#00ffcc; margin-bottom:10px; text-shadow:0 0 30px rgba(0,255,204,.8); letter-spacing:3px; animation:glow 2s ease-in-out infinite alternate; }
    @keyframes glow{ from{ text-shadow:0 0 30px rgba(0,255,204,.8);} to{ text-shadow:0 0 40px rgba(0,255,204,1),0 0 50px rgba(0,153,255,.8);} }
    .game-subtitle{ font-size:18px; color:#8899aa; margin-bottom:30px; letter-spacing:2px; }
    .menu-button{ background: linear-gradient(135deg,#00ffcc,#0099ff); border:none; color:#000; padding:15px 40px; margin:10px; border-radius:8px;
      cursor:pointer; font-size:18px; font-weight:bold; text-transform:uppercase; letter-spacing:2px; transition:.3s; display:block; width:100%; }
    .menu-button:hover{ transform:scale(1.05); box-shadow:0 10px 30px rgba(0,255,204,.6); }
    .menu-button.secondary{ background:transparent; border:2px solid #00ffcc; color:#00ffcc; }
    .high-scores{ margin-top:30px; padding-top:20px; border-top:1px solid rgba(0,255,204,.3); }
    .high-score-item{ display:flex; justify-content:space-between; padding:8px; margin:5px 0; background:rgba(0,255,204,.1); border-radius:4px; }
    #pauseMenu{ display:none; }
    .particle{ position:absolute; pointer-events:none; border-radius:50%; }
    #waveTimer{ position:absolute; top:80px; left:50%; transform:translateX(-50%); font-size:24px; color:#ffaa00; font-weight:bold;
      text-shadow:0 0 20px rgba(255,170,0,.8); background:rgba(0,0,0,.8); padding:10px 20px; border-radius:8px; border:2px solid #ffaa00; }
    .speed-control{ position:absolute; bottom:30px; left:30px; display:flex; gap:10px; background:rgba(0,0,0,.8); padding:10px; border-radius:8px; border:1px solid #00ffcc; }
    .speed-button{ background:rgba(0,255,204,.2); border:1px solid #00ffcc; color:#00ffcc; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold; transition:.2s; }
    .speed-button:hover{ background:rgba(0,255,204,.4); }
    .speed-button.active{ background:#00ffcc; color:#000; }
    .notification{ position:fixed; top:20px; right:20px; background:rgba(0,0,0,.9); color:#00ffcc; padding:15px 25px; border-radius:8px; border:2px solid #00ffcc;
      z-index:2000; animation: slideIn .3s ease-out; max-width:360px; text-align:left; }
    @keyframes slideIn{ from{ transform:translateX(100%); opacity:0;} to{ transform:translateX(0); opacity:1;} }
    .boss-warning{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,0,0,.9); color:#fff; padding:30px; border-radius:15px;
      font-size:32px; font-weight:bold; text-align:center; z-index:2000; animation: bossWarning 3s ease-in-out; }
    @keyframes bossWarning{ 0%,100%{ opacity:0; transform:translate(-50%,-50%) scale(.5);} 50%{ opacity:1; transform:translate(-50%,-50%) scale(1.1);} }
    .achievement{ position:fixed; bottom:20px; right:20px; background:linear-gradient(135deg,#ffaa00,#ff6600); color:#000; padding:15px 25px; border-radius:8px; font-weight:bold; z-index:2000; animation: achievementPop 3s ease-out; }
    @keyframes achievementPop{ 0%{ transform:translateY(100px); opacity:0;} 20%{ transform:translateY(0); opacity:1;} 80%{ transform:translateY(0); opacity:1;} 100%{ transform:translateY(100px); opacity:0;} }
  </style>
</head>
<body>
  <noscript style="color:#fff; background:#c00; padding:10px; display:block; text-align:center;">
    JavaScript is disabled; the game can’t run. Please enable JavaScript.
  </noscript>

  <div id="header">
    <div class="stat-display">
      <div class="stat-item"><span class="stat-label">WAVE:</span><span id="waveCount">1</span></div>
      <div class="stat-item"><span class="stat-label">CREDITS:</span><span id="credits">1000</span></div>
      <div class="stat-item"><span class="stat-label">SCORE:</span><span id="score">0</span></div>
      <div class="stat-item"><span class="stat-label">TOWER HP:</span><span id="towerHp">100/100</span></div>
    </div>
    <div>
      <button id="pauseBtn" class="upgrade-button">PAUSE</button>
      <button id="saveBtn" class="upgrade-button">SAVE</button>
      <button id="menuBtn" class="upgrade-button">MENU</button>
    </div>
  </div>

  <div id="gameContainer">
    <canvas id="canvas"></canvas>
    <div id="waveTimer"></div>
    <div class="speed-control">
      <button class="speed-button active" data-speed="1">1x</button>
      <button class="speed-button" data-speed="2">2x</button>
      <button class="speed-button" data-speed="3">3x</button>
    </div>
    <div id="sidePanel">
      <div class="panel-section">
        <div class="section-title">Deploy Units</div>
        <div id="unitSelection"></div>
      </div>
      <div class="panel-section">
        <div class="section-title">Upgrades</div>
        <div id="upgradesSection"></div>
      </div>
      <div class="panel-section">
        <div class="section-title">Wave Info</div>
        <div id="waveInfo"></div>
      </div>
      <div class="panel-section">
        <div class="section-title">Achievements</div>
        <div id="achievementsSection"></div>
      </div>
    </div>
  </div>

  <div id="menuOverlay">
    <div class="menu-container" id="mainMenu">
      <h1 class="game-title">ORBITAL DEFENSE</h1>
      <p class="game-subtitle">COMMAND CENTER ALPHA-9</p>
      <button id="newGameBtn" class="menu-button">NEW MISSION</button>
      <button id="continueBtn" class="menu-button secondary">CONTINUE MISSION</button>
      <button id="dailyBtn" class="menu-button secondary">DAILY CHALLENGE</button>
      <div class="high-scores">
        <div class="section-title">TOP COMMANDERS</div>
        <div id="highScoresList"></div>
      </div>
    </div>
    <div class="menu-container" id="pauseMenu" style="display:none;">
      <h2 class="game-title">MISSION PAUSED</h2>
      <button id="resumeBtn" class="menu-button">RESUME</button>
      <button id="saveProgressBtn" class="menu-button secondary">SAVE PROGRESS</button>
      <button id="abandonBtn" class="menu-button secondary">ABANDON MISSION</button>
    </div>
    <div class="menu-container" id="gameOverMenu" style="display:none;">
      <h2 class="game-title">MISSION FAILED</h2>
      <p id="finalScore" style="font-size:24px; color:#ffaa00; margin:20px 0;"></p>
      <button id="newMissionBtn" class="menu-button">NEW MISSION</button>
      <button id="mainMenuBtn" class="menu-button secondary">MAIN MENU</button>
    </div>
    <!-- Daily Challenge modal created dynamically -->
  </div>

  <script>
  (function () {
    /* --------------------- Utilities --------------------- */
    function addListener(id, type, handler) {
      var el = document.getElementById(id);
      if (el) el.addEventListener(type, handler, false);
    }
    function qsAll(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }

    /* --------------------- ObjectPool --------------------- */
    function ObjectPool(createFn, resetFn, initialSize) {
      this.createFn = createFn;
      this.resetFn = resetFn;
      this.pool = [];
      this.active = [];
      initialSize = initialSize || 50;
      for (var i = 0; i < initialSize; i++) this.pool.push(this.createFn());
    }
    ObjectPool.prototype.get = function() {
      var obj = this.pool.pop();
      if (!obj) obj = this.createFn();
      this.active.push(obj);
      return obj;
    };
    ObjectPool.prototype.release = function(obj) {
      var idx = this.active.indexOf(obj);
      if (idx > -1) {
        this.active.splice(idx, 1);
        this.resetFn(obj);
        this.pool.push(obj);
      }
    };
    ObjectPool.prototype.releaseAll = function() {
      while (this.active.length > 0) this.release(this.active[0]);
    };

    /* --------------------- Game --------------------- */
    function OrbitalDefenseGame() {
      this.canvas = document.getElementById('canvas');
      this.ctx = this.canvas.getContext('2d');
      this.setupCanvas();

      this.gameSpeed = 1;
      this.isPaused = false;
      this.isGameOver = false;
      this.selectedUnit = null;
      this.placingUnit = null;

      this._raf = null;
      this._lastFrame = 0;

      this.projectilePool = new ObjectPool(
        function(){ return { x:0,y:0,vx:0,vy:0,damage:0,color:'#fff',size:3,life:120,explosive:false,piercing:false,chainLightning:false }; },
        function(o){ o.life=120; o.explosive=o.piercing=o.chainLightning=false; },
        64
      );
      this.particlePool = new ObjectPool(
        function(){ return { x:0,y:0,vx:0,vy:0,life:30,maxLife:30,color:'#fff',size:2 }; },
        function(o){ o.life=o.maxLife; },
        128
      );

      this.wave = 1;
      this.credits = 1000;
      this.score = 0;
      this.tower = { x:0, y:0, maxHp:100, hp:100, radius:40 };

      this.units = [];
      this.enemies = [];
      this.projectiles = [];
      this.particles = [];
      this.upgrades = { damageBoost:0, rangeBoost:0, fireRateBoost:0, creditBonus:0 };

      this.achievements = {
        firstKill:{unlocked:false,name:"First Blood",desc:"Destroy your first enemy"},
        wave10:{unlocked:false,name:"Veteran",desc:"Survive 10 waves"},
        wave25:{unlocked:false,name:"Elite",desc:"Survive 25 waves"},
        score10k:{unlocked:false,name:"High Scorer",desc:"Reach 10,000 points"},
        firstBoss:{unlocked:false,name:"Boss Slayer",desc:"Defeat your first boss"},
        perfectWave:{unlocked:false,name:"Perfect Defense",desc:"Complete a wave without taking damage"}
      };

      this.waveTimer = 0;
      this.waveDelay = 15000;
      this.enemiesPerWave = 8;
      this.enemySpawnDelay = 1000;
      this.lastEnemySpawn = 0;
      this.enemiesSpawned = 0;
      this.waveActive = false;
      this.waveDamage = 0;
      this.bossWave = false;

      this.dailyChallenge = this.generateDailyChallenge();

      this.unitTypes = {
        turret:{ name:"PLASMA TURRET", cost:100, damage:15, range:120, fireRate:800, hp:50, color:'#00ffcc', size:20, projectileSpeed:8, unlocked:true },
        laser:{  name:"LASER CANNON",  cost:200, damage:8,  range:180, fireRate:150, hp:40, color:'#ff00ff', size:25, projectileSpeed:20, unlocked:false, unlockWave:3 },
        missile:{name:"MISSILE SILO",  cost:350, damage:80, range:200, fireRate:2500, hp:60, color:'#ffaa00', size:30, projectileSpeed:4, explosive:true, unlocked:false, unlockWave:5 },
        railgun:{name:"RAILGUN",       cost:500, damage:150,range:300, fireRate:3000, hp:80, color:'#00aaff', size:35, projectileSpeed:25, piercing:true, unlocked:false, unlockWave:8 },
        tesla:{  name:"TESLA COIL",    cost:600, damage:25, range:100, fireRate:400, hp:100,color:'#aaffff', size:28, projectileSpeed:0, chainLightning:true, unlocked:false, unlockWave:12 }
      };

      this.enemyTypes = [
        { name:"Scout", hp:30, speed:1.5, damage:8, reward:25, color:'#ff6666', size:12 },
        { name:"Fighter", hp:60, speed:1.2, damage:15, reward:40, color:'#ff9966', size:16 },
        { name:"Heavy", hp:120, speed:0.8, damage:25, reward:70, color:'#ff66ff', size:22 },
        { name:"Elite", hp:200, speed:1.0, damage:40, reward:120, color:'#ffff66', size:25 }
      ];

      this.mouseX = 0;
      this.mouseY = 0;

      this.setupEventListeners();
      this.loadHighScores();
      this.loadAchievements();
      this.updateUI();

      console.log('[ODC] Game initialized.');
    }

    OrbitalDefenseGame.prototype.setupCanvas = function() {
      var self = this;
      function resize() {
        var container = document.getElementById('gameContainer');
        var sidePanel = document.getElementById('sidePanel');
        var margins = 40;
        self.canvas.width  = Math.max(200, container.offsetWidth - sidePanel.offsetWidth - margins);
        self.canvas.height = Math.max(200, container.offsetHeight - margins);
        self.tower.x = self.canvas.width / 2;
        self.tower.y = self.canvas.height / 2;
      }
      resize();
      window.addEventListener('resize', resize);
    };

    OrbitalDefenseGame.prototype.setupEventListeners = function() {
      var self = this;
      this.canvas.addEventListener('mousemove', function(e){
        var rect = self.canvas.getBoundingClientRect();
        self.mouseX = e.clientX - rect.left;
        self.mouseY = e.clientY - rect.top;
      });
      this.canvas.addEventListener('click', function(){
        if (self.placingUnit) self.placeUnit(self.mouseX, self.mouseY);
      });
      this.canvas.addEventListener('contextmenu', function(e){ e.preventDefault(); self.cancelPlacement(); });
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') self.cancelPlacement();
        if (e.key === ' ') { e.preventDefault(); self.togglePause(); }
      });
    };

    OrbitalDefenseGame.prototype.generateDailyChallenge = function(){
      var today = new Date().toDateString();
      var challenges = [
        { name:"Speed Run", desc:"Survive 15 waves in under 10 minutes", type:"time" },
        { name:"Minimalist", desc:"Beat wave 10 with 5 or fewer units", type:"units" },
        { name:"Economy", desc:"Reach 5000 credits", type:"credits" },
        { name:"Pacifist", desc:"Beat 5 waves without killing any scouts", type:"pacifist" }
      ];
      var seed = 0;
      for (var i=0;i<today.length;i++) seed += today.charCodeAt(i);
      return challenges[seed % challenges.length];
    };

    OrbitalDefenseGame.prototype.startNewGame = function(){
      this.wave = 1;
      this.credits = 1000;
      this.score = 0;
      this.tower.hp = this.tower.maxHp;

      this.units = [];
      this.enemies = [];
      this.projectilePool.releaseAll();
      this.particlePool.releaseAll();
      this.projectiles = [];
      this.particles = [];

      this.upgrades = { damageBoost:0, rangeBoost:0, fireRateBoost:0, creditBonus:0 };

      this.waveTimer = 0;
      this.enemiesSpawned = 0;
      this.waveActive = false;
      this.isGameOver = false;
      this.isPaused = false;
      this.waveDamage = 0;
      this.bossWave = false;

      document.getElementById('menuOverlay').style.display = 'none';
      this.setSpeed(this.gameSpeed);
      this.updateUI();
      this.gameLoop();

      console.log('[ODC] New game started.');
    };

    OrbitalDefenseGame.prototype.saveGame = function(){
      var saveData = {
        wave:this.wave, credits:this.credits, score:this.score,
        tower:{ hp:this.tower.hp, maxHp:this.tower.maxHp },
        units:this.units.map(function(u){ return { type:u.type, x:u.x, y:u.y, hp:u.hp }; }),
        upgrades:{ damageBoost:this.upgrades.damageBoost, rangeBoost:this.upgrades.rangeBoost, fireRateBoost:this.upgrades.fireRateBoost, creditBonus:this.upgrades.creditBonus },
        timestamp: Date.now()
      };
      try { localStorage.setItem('orbitalDefenseSave', JSON.stringify(saveData)); } catch(e){}
      this.showNotification('Game Saved!');
    };

    OrbitalDefenseGame.prototype.loadGame = function(){
      var raw = null;
      try { raw = localStorage.getItem('orbitalDefenseSave'); } catch(e){}
      if (!raw) { this.showNotification('No save found!'); return; }
      var data = {};
      try { data = JSON.parse(raw); } catch(e){ this.showNotification('Save corrupted'); return; }

      this.wave = data.wave || 1;
      this.credits = data.credits || 1000;
      this.score = data.score || 0;
      if (data.tower) {
        this.tower.hp = data.tower.hp;
        this.tower.maxHp = data.tower.maxHp;
      } else {
        this.tower.hp = 100; this.tower.maxHp = 100;
      }
      this.upgrades = data.upgrades || { damageBoost:0, rangeBoost:0, fireRateBoost:0, creditBonus:0 };

      var self = this;
      this.units = (data.units || []).map(function(u){
        var def = self.unitTypes[u.type];
        return { type:u.type, x:u.x, y:u.y, hp:u.hp, maxHp:def.hp, lastFire:0,
                 name:def.name, cost:def.cost, damage:def.damage, range:def.range, fireRate:def.fireRate,
                 color:def.color, size:def.size, projectileSpeed:def.projectileSpeed,
                 explosive:!!def.explosive, piercing:!!def.piercing, chainLightning:!!def.chainLightning };
      });

      this.enemies = [];
      this.projectilePool.releaseAll();
      this.particlePool.releaseAll();
      this.projectiles = [];
      this.particles = [];
      this.waveTimer = 0;
      this.enemiesSpawned = 0;
      this.waveActive = false;
      this.isGameOver = false;
      this.isPaused = false;
      this.waveDamage = 0;
      this.bossWave = false;

      document.getElementById('menuOverlay').style.display = 'none';
      this.updateUI();
      this.gameLoop();

      console.log('[ODC] Save loaded.');
    };

    OrbitalDefenseGame.prototype.togglePause = function(){
      if (this.isGameOver) return;
      this.isPaused = !this.isPaused;
      var pauseMenu = document.getElementById('pauseMenu');
      var mainMenu = document.getElementById('mainMenu');
      if (this.isPaused) {
        document.getElementById('menuOverlay').style.display = 'flex';
        pauseMenu.style.display = 'block';
        mainMenu.style.display = 'none';
      } else {
        document.getElementById('menuOverlay').style.display = 'none';
      }
    };

    OrbitalDefenseGame.prototype.returnToMenu = function(){
      this.isPaused = true;
      this.isGameOver = true;
      document.getElementById('menuOverlay').style.display = 'flex';
      document.getElementById('pauseMenu').style.display = 'none';
      document.getElementById('gameOverMenu').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
      this.loadHighScores();
    };

    OrbitalDefenseGame.prototype.setSpeed = function(speed){
      this.gameSpeed = speed;
      qsAll('.speed-button').forEach(function(btn){
        var val = parseInt(btn.getAttribute('data-speed'), 10);
        if (val === speed) btn.classList.add('active'); else btn.classList.remove('active');
      });
    };

    OrbitalDefenseGame.prototype.selectUnit = function(type){
      var def = this.unitTypes[type];
      if (!def.unlocked) { this.showNotification('Unlocks at wave ' + def.unlockWave); return; }
      if (this.credits < def.cost) { this.showNotification('Insufficient credits!'); return; }
      this.placingUnit = type;
      qsAll('.unit-card').forEach(function(c){ c.classList.remove('selected'); });
      var card = document.querySelector('[data-unit="'+type+'"]');
      if (card) card.classList.add('selected');
    };

    OrbitalDefenseGame.prototype.cancelPlacement = function(){
      this.placingUnit = null;
      qsAll('.unit-card').forEach(function(c){ c.classList.remove('selected'); });
    };

    OrbitalDefenseGame.prototype.placeUnit = function(x, y){
      if (!this.placingUnit) return;
      var def = this.unitTypes[this.placingUnit];

      var dTower = Math.hypot(x - this.tower.x, y - this.tower.y);
      if (dTower < this.tower.radius + def.size + 20) { this.showNotification('Too close to tower!'); return; }

      for (var i=0;i<this.units.length;i++){
        var u = this.units[i];
        var d = Math.hypot(x - u.x, y - u.y);
        if (d < u.size + def.size + 10) { this.showNotification('Too close to another unit!'); return; }
      }

      this.credits -= def.cost;
      this.units.push({
        type:this.placingUnit, x:x, y:y, hp:def.hp, maxHp:def.hp, lastFire:0,
        name:def.name, cost:def.cost, damage:def.damage, range:def.range, fireRate:def.fireRate,
        color:def.color, size:def.size, projectileSpeed:def.projectileSpeed,
        explosive:!!def.explosive, piercing:!!def.piercing, chainLightning:!!def.chainLightning
      });

      this.cancelPlacement();
      this.updateUI();
      this.createParticles(x, y, def.color, 10);
    };

    OrbitalDefenseGame.prototype.spawnEnemy = function(){
      var waveMul = Math.pow(1.12, this.wave - 1);
      var idx = Math.min(Math.floor(Math.random() * (1 + this.wave / 4)), this.enemyTypes.length - 1);
      var base = this.enemyTypes[idx];

      var edge = Math.random() * 4, x, y;
      if (edge < 1){ x = Math.random() * this.canvas.width; y = 0; }
      else if (edge < 2){ x = this.canvas.width; y = Math.random() * this.canvas.height; }
      else if (edge < 3){ x = Math.random() * this.canvas.width; y = this.canvas.height; }
      else { x = 0; y = Math.random() * this.canvas.height; }

      this.enemies.push({
        x:x, y:y,
        hp:Math.floor(base.hp * waveMul),
        maxHp:Math.floor(base.hp * waveMul),
        speed: base.speed * (1 + this.wave * 0.015),
        damage: Math.floor(base.damage * waveMul),
        reward: Math.floor(base.reward * (1 + this.upgrades.creditBonus * 0.1)),
        color: base.color, size: base.size, type: base.name
      });
    };

    OrbitalDefenseGame.prototype.spawnBoss = function(){
      var mul = Math.pow(1.3, Math.floor(this.wave/10));
      var x = this.canvas.width/2, y = 0;
      this.enemies.push({
        x:x,y:y, hp:Math.floor(1000*mul), maxHp:Math.floor(1000*mul),
        speed:0.5, damage:Math.floor(100*mul), reward:Math.floor(500*mul),
        color:'#ff0000', size:50, type:'Boss', isBoss:true
      });
      this.showBossWarning();
    };

    OrbitalDefenseGame.prototype.showBossWarning = function(){
      var w = document.createElement('div');
      w.className = 'boss-warning';
      w.textContent = 'BOSS INCOMING!';
      document.body.appendChild(w);
      setTimeout(function(){ if (w.parentNode) w.parentNode.removeChild(w); }, 3000);
    };

    OrbitalDefenseGame.prototype.startWave = function(){
      this.waveActive = true;
      this.enemiesSpawned = 0;
      this.lastEnemySpawn = 0;
      this.waveDamage = 0;

      for (var k in this.unitTypes) {
        var u = this.unitTypes[k];
        if (u.unlockWave && this.wave >= u.unlockWave && !u.unlocked) {
          u.unlocked = true;
          this.showNotification(u.name + ' unlocked!');
        }
      }

      this.bossWave = (this.wave % 10 === 0);
      if (this.bossWave) {
        this.enemiesPerWave = 1;
        this.spawnBoss();
        this.enemiesSpawned = 1;
      } else {
        this.enemiesPerWave = Math.floor(8 + this.wave * 1.5);
      }

      this.updateUI();
    };

    OrbitalDefenseGame.prototype.endWave = function(){
      this.waveActive = false;
      this.waveTimer = 0;
      this.wave++;

      var bonus = Math.floor(50 + this.wave * 10);
      this.credits += bonus;
      this.score += bonus * 2;

      if (this.waveDamage === 0 && this.wave > 1) this.unlockAchievement('perfectWave');
      if (this.wave === 10) this.unlockAchievement('wave10');
      if (this.wave === 25) this.unlockAchievement('wave25');

      this.showNotification('Wave ' + (this.wave - 1) + ' Complete! +' + bonus + ' credits');
      this.updateUI();
    };

    OrbitalDefenseGame.prototype.updateGame = function(delta){
      if (this.isPaused || this.isGameOver) return;
      var dt = delta * this.gameSpeed;

      if (!this.waveActive) {
        this.waveTimer += dt;
        if (this.waveTimer >= this.waveDelay) this.startWave();
      } else {
        if (!this.bossWave && this.enemiesSpawned < this.enemiesPerWave) {
          this.lastEnemySpawn += dt;
          if (this.lastEnemySpawn >= this.enemySpawnDelay) {
            this.spawnEnemy();
            this.enemiesSpawned++;
            this.lastEnemySpawn = 0;
          }
        }
        if (this.enemiesSpawned >= this.enemiesPerWave && this.enemies.length === 0) {
          this.endWave();
        }
      }

      for (var i=this.enemies.length-1;i>=0;i--){
        var e = this.enemies[i];
        var dx = this.tower.x - e.x, dy = this.tower.y - e.y;
        var dist = Math.hypot(dx, dy);
        if (dist > this.tower.radius + e.size) {
          e.x += (dx/dist) * e.speed * (dt/16);
          e.y += (dy/dist) * e.speed * (dt/16);
        } else {
          this.tower.hp -= e.damage;
          this.waveDamage += e.damage;
          this.createParticles(e.x, e.y, '#ff0000', 20);
          this.enemies.splice(i,1);
          if (this.tower.hp <= 0) this.gameOver();
        }
      }

      for (var uIdx=0; uIdx<this.units.length; uIdx++){
        var unit = this.units[uIdx];
        unit.lastFire += dt;
        var fr = unit.fireRate * (1 - this.upgrades.fireRateBoost * 0.1);
        var rng = unit.range * (1 + this.upgrades.rangeBoost * 0.1);
        if (unit.lastFire >= fr) {
          var target = null, min = rng;
          for (var j=0;j<this.enemies.length;j++){
            var en = this.enemies[j];
            var d = Math.hypot(en.x - unit.x, en.y - unit.y);
            if (d < min) { target = en; min = d; }
          }
          if (target) { this.fireProjectile(unit, target); unit.lastFire = 0; }
        }
      }

      for (var pIdx=this.projectiles.length-1; pIdx>=0; pIdx--){
        var p = this.projectiles[pIdx];
        p.x += p.vx * (dt/16);
        p.y += p.vy * (dt/16);
        p.life--;
        if (p.life <= 0) { this.projectilePool.release(p); this.projectiles.splice(pIdx,1); continue; }
        for (var k2=this.enemies.length-1; k2>=0; k2--){
          var ee = this.enemies[k2];
          var dd = Math.hypot(p.x - ee.x, p.y - ee.y);
          if (dd < ee.size + p.size) {
            if (p.explosive) {
              this.handleExplosion(p.x, p.y, p.damage);
              this.projectilePool.release(p); this.projectiles.splice(pIdx,1);
            } else if (p.piercing) {
              this.damageEnemy(ee, p.damage);
            } else if (p.chainLightning) {
              this.handleChainLightning(ee, p.damage, 3);
              this.projectilePool.release(p); this.projectiles.splice(pIdx,1);
            } else {
              this.damageEnemy(ee, p.damage);
              this.projectilePool.release(p); this.projectiles.splice(pIdx,1);
            }
            break;
          }
        }
      }

      for (var pr=this.particles.length-1; pr>=0; pr--){
        var part = this.particles[pr];
        part.x += part.vx * (dt/16);
        part.y += part.vy * (dt/16);
        part.life--;
        if (part.life <= 0) { this.particlePool.release(part); this.particles.splice(pr,1); }
      }

      this.updateUI();
    };

    OrbitalDefenseGame.prototype.fireProjectile = function(unit, target){
      var dx = target.x - unit.x, dy = target.y - unit.y;
      var dist = Math.hypot(dx, dy) || 1;
      var proj = this.projectilePool.get();
      proj.x = unit.x; proj.y = unit.y;
      proj.vx = (dx / dist) * (unit.projectileSpeed || 16);
      proj.vy = (dy / dist) * (unit.projectileSpeed || 16);
      proj.damage = Math.round(unit.damage * (1 + this.upgrades.damageBoost * 0.1));
      proj.color = unit.color;
      proj.size = unit.name.indexOf('MISSILE') > -1 ? 6 : 3;
      proj.explosive = !!unit.explosive;
      proj.piercing = !!unit.piercing;
      proj.chainLightning = !!unit.chainLightning;
      proj.life = 120;
      this.projectiles.push(proj);
    };

    OrbitalDefenseGame.prototype.damageEnemy = function(enemy, damage){
      enemy.hp -= damage;
      this.createParticles(enemy.x, enemy.y, enemy.color, 5);
      if (enemy.hp <= 0) {
        this.credits += enemy.reward;
        this.score += enemy.reward * 2;
        if (this.score >= 10000) this.unlockAchievement('score10k');
        if (enemy.isBoss) this.unlockAchievement('firstBoss');
        if (!this.achievements.firstKill.unlocked) this.unlockAchievement('firstKill');
        this.createParticles(enemy.x, enemy.y, '#ffaa00', 15);
        var idx = this.enemies.indexOf(enemy);
        if (idx > -1) this.enemies.splice(idx, 1);
      }
    };

    OrbitalDefenseGame.prototype.handleExplosion = function(x,y,damage){
      this.createParticles(x,y,'#ffaa00',25);
      for (var i=0;i<this.enemies.length;i++){
        var e = this.enemies[i];
        var d = Math.hypot(e.x - x, e.y - y);
        if (d < 80) {
          var dealt = Math.max(1, Math.round(damage * (1 - d/80)));
          this.damageEnemy(e, dealt);
        }
      }
    };

    OrbitalDefenseGame.prototype.handleChainLightning = function(startEnemy, damage, chains){
      this.damageEnemy(startEnemy, damage);
      if (chains <= 0) return;
      var closest = null, minDist = 150;
      for (var i=0;i<this.enemies.length;i++){
        var e = this.enemies[i];
        if (e === startEnemy) continue;
        var d = Math.hypot(e.x - startEnemy.x, e.y - startEnemy.y);
        if (d < minDist) { closest = e; minDist = d; }
      }
      var self = this;
      if (closest) setTimeout(function(){ self.handleChainLightning(closest, Math.round(damage*0.7), chains - 1); }, 100);
    };

    OrbitalDefenseGame.prototype.createParticles = function(x,y,color,count){
      for (var i=0;i<count;i++){
        var p = this.particlePool.get();
        p.x = x; p.y = y;
        p.vx = (Math.random()-0.5)*8;
        p.vy = (Math.random()-0.5)*8;
        p.color = color;
        p.size = Math.random()*4 + 1;
        p.life = Math.floor(Math.random()*30 + 20);
        p.maxLife = p.life;
        this.particles.push(p);
      }
    };

    OrbitalDefenseGame.prototype.gameOver = function(){
      this.isGameOver = true;
      this.isPaused = true;
      this.saveHighScore(this.score);
      document.getElementById('menuOverlay').style.display = 'flex';
      document.getElementById('finalScore').textContent = 'Final Score: ' + this.score.toLocaleString();
      document.getElementById('gameOverMenu').style.display = 'block';
      document.getElementById('mainMenu').style.display = 'none';
    };

    OrbitalDefenseGame.prototype.render = function(){
      var ctx = this.ctx;
      ctx.clearRect(0,0,this.canvas.width,this.canvas.height);

      ctx.fillStyle = 'rgba(255,255,255,.8)';
      for (var i=0;i<100;i++){
        var x = (i*137.5) % this.canvas.width;
        var y = (i*317.3) % this.canvas.height;
        ctx.fillRect(x,y,1,1);
      }

      ctx.fillStyle = this.tower.hp > 50 ? '#00ffcc' : '#ff6666';
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(this.tower.x,this.tower.y,this.tower.radius,0,Math.PI*2);
      ctx.fill(); ctx.stroke();

      var hpPct = Math.max(0,this.tower.hp)/this.tower.maxHp;
      ctx.fillStyle = '#333';
      ctx.fillRect(this.tower.x-40, this.tower.y-60, 80, 8);
      ctx.fillStyle = hpPct>0.5 ? '#00ff00' : (hpPct>0.25 ? '#ffaa00' : '#ff0000');
      ctx.fillRect(this.tower.x-40, this.tower.y-60, 80*hpPct, 8);

      for (var u=0; u<this.units.length; u++){
        var unit = this.units[u];
        ctx.fillStyle = unit.color;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;

        if (unit.name.indexOf('TURRET')>-1) {
          ctx.fillRect(unit.x-unit.size/2, unit.y-unit.size/2, unit.size, unit.size);
          ctx.strokeRect(unit.x-unit.size/2, unit.y-unit.size/2, unit.size, unit.size);
        } else {
          ctx.beginPath(); ctx.arc(unit.x, unit.y, unit.size/2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        }

        var pct = unit.hp / unit.maxHp;
        if (pct < 1) {
          ctx.fillStyle = '#333';
          ctx.fillRect(unit.x-15, unit.y - unit.size/2 - 8, 30, 4);
          ctx.fillStyle = pct>0.5 ? '#00ff00' : (pct>0.25 ? '#ffaa00' : '#ff0000');
          ctx.fillRect(unit.x-15, unit.y - unit.size/2 - 8, 30*pct, 4);
        }

        if (this.placingUnit === unit.type || unit === this.selectedUnit) {
          ctx.strokeStyle = 'rgba(0,255,204,.3)';
          ctx.lineWidth = 1;
          ctx.beginPath(); ctx.arc(unit.x, unit.y, unit.range*(1 + this.upgrades.rangeBoost*0.1), 0, Math.PI*2); ctx.stroke();
        }
      }

      for (var e=0;e<this.enemies.length;e++){
        var enemy = this.enemies[e];
        ctx.fillStyle = enemy.color;
        ctx.strokeStyle = enemy.isBoss ? '#fff' : '#333';
        ctx.lineWidth = enemy.isBoss ? 3 : 1;
        ctx.beginPath(); ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI*2); ctx.fill(); ctx.stroke();

        var ep = enemy.hp / enemy.maxHp;
        ctx.fillStyle = '#333';
        ctx.fillRect(enemy.x - enemy.size, enemy.y - enemy.size - 8, enemy.size * 2, 4);
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(enemy.x - enemy.size, enemy.y - enemy.size - 8, enemy.size * 2 * ep, 4);

        if (enemy.isBoss) {
          ctx.fillStyle = '#ffaa00'; ctx.font = '12px Arial'; ctx.textAlign = 'center';
          ctx.fillText('BOSS', enemy.x, enemy.y - enemy.size - 15);
        }
      }

      for (var p=0;p<this.projectiles.length;p++){
        var proj = this.projectiles[p];
        ctx.fillStyle = proj.color; ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI*2); ctx.fill(); ctx.stroke();
      }

      for (var i2=0;i2<this.particles.length;i2++){
        var part = this.particles[i2];
        var alpha = part.life / part.maxLife;
        ctx.globalAlpha = Math.max(0, Math.min(1, alpha));
        ctx.fillStyle = part.color;
        ctx.beginPath(); ctx.arc(part.x, part.y, part.size * alpha, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
      }

      if (this.placingUnit) {
        var def = this.unitTypes[this.placingUnit];
        ctx.fillStyle = 'rgba(0,255,204,.5)';
        ctx.strokeStyle = '#00ffcc';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(this.mouseX, this.mouseY, def.size/2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.strokeStyle = 'rgba(0,255,204,.3)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(this.mouseX, this.mouseY, def.range, 0, Math.PI*2); ctx.stroke();
      }
    };

    OrbitalDefenseGame.prototype.updateUI = function(){
      document.getElementById('waveCount').textContent = this.wave;
      document.getElementById('credits').textContent = this.credits.toLocaleString();
      document.getElementById('score').textContent = this.score.toLocaleString();
      document.getElementById('towerHp').textContent = Math.max(0, Math.round(this.tower.hp)) + '/' + this.tower.maxHp;

      var timer = document.getElementById('waveTimer');
      if (!this.waveActive && !this.isGameOver) {
        var remaining = Math.max(0, Math.ceil((this.waveDelay - this.waveTimer)/1000));
        timer.textContent = 'Next wave in: ' + remaining + 's';
        timer.style.display = 'block';
      } else {
        timer.style.display = 'none';
      }

      this.updateUnitSelection();
      this.updateUpgrades();
      this.updateWaveInfo();
      this.updateAchievements();
    };

    OrbitalDefenseGame.prototype.updateUnitSelection = function(){
      var container = document.getElementById('unitSelection');
      container.innerHTML = '';
      var self = this;
      Object.keys(this.unitTypes).forEach(function(type){
        var unit = self.unitTypes[type];
        var canAfford = self.credits >= unit.cost;

        var card = document.createElement('div');
        card.className = 'unit-card ' + ((!unit.unlocked || !canAfford) ? 'disabled' : '');
        card.setAttribute('data-unit', type);
        card.addEventListener('click', function(){ self.selectUnit(type); });
        card.innerHTML =
          '<div class="unit-name">'+unit.name+'</div>'+
          '<div class="unit-stats">Damage: '+unit.damage+' | Range: '+unit.range+'<br>Fire Rate: '+(1000/unit.fireRate).toFixed(1)+'/s | HP: '+unit.hp+'</div>'+
          '<div class="unit-cost">Cost: '+unit.cost+' credits</div>' +
          (!unit.unlocked ? '<div style="color:#ffaa00;font-size:12px;">Unlocks Wave '+unit.unlockWave+'</div>' : '');
        container.appendChild(card);
      });
    };

    OrbitalDefenseGame.prototype.updateUpgrades = function(){
      var container = document.getElementById('upgradesSection');
      var defs = [
        { key:'damageBoost', name:'Damage Boost', cost:200, max:10, desc:'+10% damage / level' },
        { key:'rangeBoost', name:'Range Boost', cost:150, max:10, desc:'+10% range / level' },
        { key:'fireRateBoost', name:'Fire Rate Boost', cost:250, max:10, desc:'+10% fire rate / level' },
        { key:'creditBonus', name:'Credit Bonus', cost:300, max:5, desc:'+10% rewards / level' }
      ];
      var self = this;
      container.innerHTML = '';
      defs.forEach(function(up){
        var level = self.upgrades[up.key] || 0;
        var cost = up.cost * (level + 1);
        var canAfford = self.credits >= cost && level < up.max;

        var card = document.createElement('div');
        card.className = 'unit-card ' + (!canAfford ? 'disabled' : '');
        card.innerHTML =
          '<div class="unit-name">'+up.name+'</div>'+
          '<div class="unit-stats">Level: '+level+'/'+up.max+' &nbsp; <span style="color:#8899aa">'+up.desc+'</span></div>'+
          '<div class="unit-cost">Cost: '+cost+' credits</div>';

        var btn = document.createElement('button');
        btn.className = 'upgrade-button';
        btn.textContent = 'UPGRADE';
        btn.disabled = !canAfford;
        btn.addEventListener('click', function(){ self.purchaseUpgrade(up.key); });

        card.appendChild(btn);
        container.appendChild(card);
      });
    };

    OrbitalDefenseGame.prototype.purchaseUpgrade = function(key){
      var table = { damageBoost:{cost:200,max:10}, rangeBoost:{cost:150,max:10}, fireRateBoost:{cost:250,max:10}, creditBonus:{cost:300,max:5} };
      var def = table[key]; if (!def) return;
      var level = this.upgrades[key] || 0;
      if (level >= def.max) return;
      var cost = def.cost * (level + 1);
      if (this.credits < cost) { this.showNotification('Insufficient credits!'); return; }
      this.credits -= cost;
      this.upgrades[key] = level + 1;
      this.updateUI();
    };

    OrbitalDefenseGame.prototype.updateWaveInfo = function(){
      var container = document.getElementById('waveInfo');
      var nextWave = this.wave + (this.waveActive ? 0 : 1);
      var isBoss = nextWave % 10 === 0;
      var hpScale = Math.floor((Math.pow(1.12, nextWave - 1) - 1) * 100);
      var dmgScale = hpScale;
      var spdScale = Math.floor(nextWave * 1.5);
      container.innerHTML =
        '<div style="margin-bottom:15px;"><strong>Wave '+nextWave+'</strong><br>'+
        (isBoss ? '<span style="color:#ff0000;font-weight:bold;">BOSS WAVE</span>' : 'Enemies: '+Math.floor(8 + nextWave * 1.5))+
        '</div>'+
        '<div style="font-size:14px; color:#8899aa; line-height:1.6;">'+
          'Enemy HP: +'+hpScale+'%<br>'+
          'Enemy Speed: +'+spdScale+'%<br>'+
          'Enemy Damage: +'+dmgScale+'%<br>'+
          'Rewards Bonus: +'+Math.floor(this.upgrades.creditBonus*10)+'%'+
        '</div>';
    };

    OrbitalDefenseGame.prototype.updateAchievements = function(){
      var el = document.getElementById('achievementsSection');
      el.innerHTML = '';
      var self = this;
      Object.keys(this.achievements).forEach(function(key){
        var a = self.achievements[key];
        var row = document.createElement('div');
        row.className = 'high-score-item';
        row.style.opacity = a.unlocked ? '1' : '0.5';
        row.innerHTML = '<span>'+a.name+'</span><span>'+(a.unlocked ? '✓' : '—')+'</span>';
        el.appendChild(row);
      });
    };

    OrbitalDefenseGame.prototype.unlockAchievement = function(key){
      var a = this.achievements[key];
      if (!a || a.unlocked) return;
      a.unlocked = true;
      this.saveAchievements();
      var toast = document.createElement('div');
      toast.className = 'achievement';
      toast.textContent = 'Achievement Unlocked: ' + a.name;
      document.body.appendChild(toast);
      setTimeout(function(){ if (toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
    };

    OrbitalDefenseGame.prototype.loadAchievements = function(){
      try {
        var raw = localStorage.getItem('orbitalDefenseAchievements');
        if (!raw) return;
        var saved = JSON.parse(raw);
        for (var k in this.achievements) {
          if (saved[k] && saved[k].unlocked) this.achievements[k].unlocked = true;
        }
      } catch(e){}
    };

    OrbitalDefenseGame.prototype.saveAchievements = function(){
      try { localStorage.setItem('orbitalDefenseAchievements', JSON.stringify(this.achievements)); } catch(e){}
    };

    OrbitalDefenseGame.prototype.loadHighScores = function(){
      var list = document.getElementById('highScoresList');
      var scores = [];
      try { scores = JSON.parse(localStorage.getItem('orbitalDefenseHighScores') || '[]') || []; } catch(e){}
      scores.sort(function(a,b){ return b.score - a.score; });
      scores = scores.slice(0,10);
      list.innerHTML = scores.length ? scores.map(function(s){
        var date = new Date(s.time).toLocaleDateString();
        return '<div class="high-score-item"><span>'+date+'</span><span>'+s.score.toLocaleString()+'</span></div>';
      }).join('') : '<div class="unit-stats">No scores yet. Be the first!</div>';
    };

    OrbitalDefenseGame.prototype.saveHighScore = function(score){
      try {
        var raw = localStorage.getItem('orbitalDefenseHighScores');
        var arr = raw ? JSON.parse(raw) : [];
        arr.push({ score:score, time:Date.now() });
        arr.sort(function(a,b){ return b.score - a.score; });
        localStorage.setItem('orbitalDefenseHighScores', JSON.stringify(arr.slice(0,25)));
        this.loadHighScores();
      } catch(e){}
    };

    OrbitalDefenseGame.prototype.showNotification = function(message, duration){
      duration = duration || 2500;
      var n = document.createElement('div');
      n.className = 'notification';
      n.innerHTML = '<strong>Command:</strong> ' + message;
      document.body.appendChild(n);
      setTimeout(function(){ if (n.parentNode) n.parentNode.removeChild(n); }, duration);
    };

    OrbitalDefenseGame.prototype.showDailyChallenge = function(){
      var modal = document.getElementById('dailyMenu');
      if (!modal) {
        modal = document.createElement('div');
        modal.className = 'menu-container';
        modal.id = 'dailyMenu';
        document.getElementById('menuOverlay').appendChild(modal);
      }
      var c = this.dailyChallenge;
      modal.innerHTML =
        '<h2 class="game-title">DAILY CHALLENGE</h2>'+
        '<p class="game-subtitle">'+c.name+'</p>'+
        '<div style="color:#8899aa; margin-bottom:20px;">'+c.desc+'</div>'+
        '<button class="menu-button" id="startChallengeBtn">START CHALLENGE</button>'+
        '<button class="menu-button secondary" id="backToMenuBtn">BACK</button>';
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('pauseMenu').style.display = 'none';
      document.getElementById('gameOverMenu').style.display = 'none';
      document.getElementById('menuOverlay').style.display = 'flex';
      modal.style.display = 'block';

      var self = this;
      document.getElementById('startChallengeBtn').onclick = function(){
        if (c.type === 'time') self.waveDelay = 9000;
        if (c.type === 'units') self.unitCap = 5;
        if (c.type === 'credits') self.credits = 1500;
        if (c.type === 'pacifist') self.scoutPacifist = true;
        self.startNewGame();
        modal.style.display = 'none';
      };
      document.getElementById('backToMenuBtn').onclick = function(){
        modal.style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
      };
    };

    OrbitalDefenseGame.prototype.gameLoop = function(){
      var self = this;
      function step(ts){
        if (!self._lastFrame) self._lastFrame = ts;
        var delta = Math.min(64, ts - self._lastFrame);
        self._lastFrame = ts;
        self.updateGame(delta);
        self.render();
        self._raf = requestAnimationFrame(step);
      }
      if (this._raf) cancelAnimationFrame(this._raf);
      this._lastFrame = 0;
      this._raf = requestAnimationFrame(step);
    };

    /* --------------------- Boot --------------------- */
    var game = new OrbitalDefenseGame();
    window.game = game; // optional

    // Wire UI (no optional chaining)
    addListener('pauseBtn', 'click', function(){ game.togglePause(); });
    addListener('saveBtn', 'click', function(){ game.saveGame(); });
    addListener('menuBtn', 'click', function(){ game.returnToMenu(); });

    addListener('newGameBtn', 'click', function(){ game.startNewGame(); });
    addListener('continueBtn', 'click', function(){ game.loadGame(); });
    addListener('dailyBtn', 'click', function(){ game.showDailyChallenge(); });

    addListener('resumeBtn', 'click', function(){ game.togglePause(); });
    addListener('saveProgressBtn', 'click', function(){ game.saveGame(); });
    addListener('
